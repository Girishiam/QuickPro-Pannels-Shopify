<div class="product-grid-custom page-width section-{{ section.id }}-padding">
  
  {% comment %} Filter Bar {% endcomment %}
  <div class="filter-bar">
    <div class="filter-left">
      <span class="filter-label">Filter:</span>
      <div class="filter-dropdown" data-filter-type="availability">
        <button class="filter-toggle">Availability <span class="arrow">∨</span></button>
        <div class="filter-menu">
           <label><input type="checkbox" value="in-stock" class="filter-checkbox" checked> In stock</label>
           <label><input type="checkbox" value="out-of-stock" class="filter-checkbox" checked> Out of stock</label>
        </div>
      </div>
      <div class="filter-dropdown" data-filter-type="price">
        <button class="filter-toggle">Price <span class="arrow">∨</span></button>
        <div class="filter-menu">
           <div class="price-range-inputs">
             <input type="number" placeholder="From $" id="price-min" class="price-input">
             <input type="number" placeholder="To $" id="price-max" class="price-input">
           </div>
        </div>
      </div>
    </div>
    
    <div class="filter-right">
       <div class="sort-dropdown">
        <span class="sort-label">Sort:</span>
        <select id="sort-select">
          <option value="featured">Featured</option>
          <option value="price-low">Price, low to high</option>
          <option value="price-high">Price, high to low</option>
        </select>
       </div>
       <span class="product-count">{{ section.blocks.size }} products</span>
    </div>
  </div>

  {% comment %} Product Grid {% endcomment %}
  <div class="product-grid-container" id="product-grid">
    {%- if section.blocks.size > 0 -%}
      {%- for block in section.blocks -%}
        {%- liquid
          assign product_ref = block.settings.product_item
          
          # Resolve Data Priorities
          assign title = product_ref.title | default: block.settings.title
          assign url = product_ref.url | default: block.settings.url | default: '#'
          
          if product_ref != blank
            assign price = product_ref.price | money_without_trailing_zeros
            assign image = product_ref.featured_media
            if product_ref.available
               assign in_stock = 'true'
            else
               assign in_stock = 'false'
            endif
          else
            assign price = block.settings.price | prepend: '$'
            assign image = block.settings.image
            if block.settings.in_stock
               assign in_stock = 'true'
            else
               assign in_stock = 'false'
            endif
          endif
          
          # Allow custom image override
          if block.settings.image != blank
            assign image = block.settings.image
          endif
        -%}
  
        <a href="{{ url }}" class="product-card" 
             data-price="{{ price | remove: '$' }}" 
             data-stock="{{ in_stock }}"
             {{ block.shopify_attributes }}>
          
          <div class="product-image-wrapper">
            {%- if image != blank -%}
               {{ image | image_url: width: 600 | image_tag: 
                class: 'product-image',
                loading: 'lazy'
              }}
            {%- else -%}
               {% comment %} Fallback to assets/productX.webp based on index {% endcomment %}
               {% assign img_index = forloop.index %}
               <img src="{{ 'product' | append: img_index | append: '.webp' | asset_url }}" 
                    alt="{{ title }}" 
                    class="product-image"
                    loading="lazy"
                    width="600"
                    height="600">
            {%- endif -%}
          </div>
          
          <div class="product-info">
            <h3 class="product-title">{{ title | escape }}</h3>
            <p class="product-price">{{ price }}</p>
          </div>
          
        </a>
      {%- endfor -%}
    {%- else -%}
    {%- else -%}
      {% comment %} Dynamic Collection Products {% endcomment %}
      {%- liquid
         assign target_collection = collection
         if section.settings.collection != blank
            assign target_collection = section.settings.collection
         endif
      -%}

      {%- for product in target_collection.products -%}
        {%- liquid
          assign title = product.title
          assign url = product.url
          assign price = product.price | money_without_trailing_zeros
          assign image = product.featured_media
          if product.available
             assign in_stock = 'true'
          else
             assign in_stock = 'false'
          endif
        -%}
  
        <a href="{{ url }}" class="product-card" 
             data-price="{{ price | remove: '$' }}" 
             data-stock="{{ in_stock }}">
          
          <div class="product-image-wrapper">
            {%- if image != blank -%}
               {{ image | image_url: width: 600 | image_tag: 
                class: 'product-image',
                loading: 'lazy'
              }}
            {%- else -%}
              <!-- No Image Fallback -->
               <div class="product-image" style="background-color: #eee;"></div>
            {%- endif -%}
          </div>
          
          <div class="product-info">
            <h3 class="product-title">{{ title | escape }}</h3>
            <p class="product-price">{{ price }}</p>
          </div>
          
        </a>
      {%- endfor -%}
    {%- endif -%}
  </div>

  {% comment %} Pagination Controls {% endcomment %}
  <div class="pagination-controls" id="pagination-controls">
    <button id="prev-page" class="pagination-btn" disabled>&lt; Previous</button>
    <span id="page-info">Page 1 of 1</span>
    <button id="next-page" class="pagination-btn" disabled>Next &gt;</button>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const grid = document.getElementById('product-grid');
  const cards = Array.from(grid.getElementsByClassName('product-card'));
  const countLabel = document.querySelector('.product-count');
  const sortSelect = document.getElementById('sort-select');
  const priceMinInput = document.getElementById('price-min');
  const priceMaxInput = document.getElementById('price-max');
  const stockCheckboxes = document.querySelectorAll('input[value="in-stock"], input[value="out-of-stock"]');
  
  // Pagination Elements
  const prevBtn = document.getElementById('prev-page');
  const nextBtn = document.getElementById('next-page');
  const pageInfo = document.getElementById('page-info');
  const paginationControls = document.getElementById('pagination-controls');

  const PRODUCTS_PER_PAGE = 6; 
  let currentPage = 1;

  // Filter Toggle Logic
  document.querySelectorAll('.filter-toggle').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const dropdown = btn.closest('.filter-dropdown');
      // Close others
      document.querySelectorAll('.filter-dropdown').forEach(d => {
         if(d !== dropdown) d.classList.remove('active');
      });
      dropdown.classList.toggle('active');
    });
  });

  // Close sorting when clicking outside
  document.addEventListener('click', () => {
     document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('active'));
  });
  
  document.querySelectorAll('.filter-dropdown').forEach(d => {
    d.addEventListener('click', (e) => e.stopPropagation());
  });


  function filterAndSort() {
     const minPrice = parseFloat(priceMinInput.value) || 0;
     const maxPrice = parseFloat(priceMaxInput.value) || Infinity;
     const showInStock = document.querySelector('input[value="in-stock"]').checked;
     const showOutOfStock = document.querySelector('input[value="out-of-stock"]').checked;

     // 1. Filter Logic
     const visibleCards = cards.filter(card => {
        const price = parseFloat(card.dataset.price);
        const inStock = card.dataset.stock === 'true';

        if (price < minPrice || price > maxPrice) return false;
        if (inStock && !showInStock) return false;
        if (!inStock && !showOutOfStock) return false;
        return true;
     });

     // 2. Sort Logic
     const sortValue = sortSelect.value;
     visibleCards.sort((a, b) => {
        const priceA = parseFloat(a.dataset.price);
        const priceB = parseFloat(b.dataset.price);
        
        if (sortValue === 'price-low') return priceA - priceB;
        if (sortValue === 'price-high') return priceB - priceA;
        return 0; // Featured
     });

     // 3. Pagination Logic
     const totalPages = Math.ceil(visibleCards.length / PRODUCTS_PER_PAGE) || 1;
     
     // Reset to page 1 if current page is out of bounds
     if (currentPage > totalPages) currentPage = 1;

     const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;
     const endIndex = startIndex + PRODUCTS_PER_PAGE;
     const pageCards = visibleCards.slice(startIndex, endIndex);

     // 4. Render
     // First hide all cards
     cards.forEach(card => card.style.display = 'none');
     
     // Appending moves them in DOM (sort order) AND we show only current page
     // Clear grid visual content? No, just ensure display property
     // To respect SORT ORDER, we must re-append ALL visible cards to the grid in correct order,
     // then hide the ones not on current page.
     
     // Clear container
     // grid.innerHTML = ''; // This destroys listeners? No, card elements are cached in 'cards' array. 
     // But 'cards' is array of ELEMENTS. 
     // Appending them moves them.
     
     visibleCards.forEach(card => {
        grid.appendChild(card); // Re-orders them visually
        card.style.display = 'none'; // Default hidden
     });
     
     // Show only current page
     pageCards.forEach(card => {
         card.style.display = 'flex';
     });

     // Update Counts & UI
     countLabel.innerText = `${visibleCards.length} products`;
     pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
     
     prevBtn.disabled = (currentPage === 1);
     nextBtn.disabled = (currentPage === totalPages);
     
     // Hide pagination if no pages needed (start 0 or 1 page)
     if (visibleCards.length <= PRODUCTS_PER_PAGE) {
        paginationControls.style.display = 'none';
     } else {
        paginationControls.style.display = 'flex';
     }
  }

  // Pagination Events
  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      filterAndSort();
      // Scroll to top of grid
      grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });

  nextBtn.addEventListener('click', () => {
    // We need to know max pages, recalculating inside click is safe or storing global
    currentPage++; // formatting will clamp it if it goes over in next run
    filterAndSort();
    grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  // Event Listeners for Filters
  sortSelect.addEventListener('change', () => { currentPage = 1; filterAndSort(); });
  priceMinInput.addEventListener('input', () => { currentPage = 1; filterAndSort(); });
  priceMaxInput.addEventListener('input', () => { currentPage = 1; filterAndSort(); });
  stockCheckboxes.forEach(cb => cb.addEventListener('change', () => { currentPage = 1; filterAndSort(); }));

  // Initial Run
  filterAndSort();

});
</script>

<style>
  /* ... Existing CSS ... */
  /* Pagination Styles */
  .pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 50px;
  }

  .pagination-btn {
    background: transparent;
    border: 1px solid #121212;
    padding: 12px 24px;
    cursor: pointer;
    font-size: 1.3rem;
    font-weight: 500;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    transition: all 0.3s ease;
    color: #121212;
    min-width: 120px;
  }

  .pagination-btn:hover:not(:disabled) {
    background: #121212;
    color: #fff;
  }

  .pagination-btn:disabled {
    border-color: #e5e5e5;
    color: #999;
    cursor: not-allowed;
  }

  #page-info {
    font-size: 1.4rem;
    color: #121212;
    font-weight: 500;
    margin: 0 15px;
    font-family: inherit;
  }

  .product-grid-custom {
    padding-top: 40px;
    padding-bottom: 60px;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    margin-bottom: 40px;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
  }

  .filter-left, .filter-right {
    display: flex;
    align-items: center;
    gap: 30px;
  }

  .filter-label {
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
    margin-right: 10px;
  }

  .filter-dropdown {
    position: relative;
  }

  .filter-toggle {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #121212;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 0;
    transition: color 0.2s;
  }
  
  .filter-toggle:hover {
    color: #555;
  }
  
  .filter-toggle .arrow {
    font-size: 1rem;
    transition: transform 0.2s;
  }
  
  .filter-dropdown.active .arrow {
    transform: rotate(180deg);
  }

  .filter-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #e5e5e5;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    z-index: 100; /* Higher z-index */
    min-width: 240px;
    border-radius: 4px;
    margin-top: 10px;
  }

  .filter-dropdown.active .filter-menu {
    display: block;
    animation: fadeIn 0.1s ease-out;
  }

  .filter-menu label {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    cursor: pointer;
    font-size: 1.4rem;
    color: #444;
  }
  
  .filter-menu label:last-child {
    margin-bottom: 0;
  }

  .filter-checkbox {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: #000;
  }

  .price-range-inputs {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .price-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1.4rem;
  }
  
  .filter-right .sort-label {
    margin-right: 10px;
    color: #555;
  }

  #sort-select {
    border: none;
    font-size: 1.4rem;
    font-weight: 500;
    cursor: pointer;
    padding-right: 10px;
    color: #121212;
    outline: none;
    background: transparent;
  }
  
  .product-count {
    font-size: 1.4rem;
    color: #777;
    margin-left: 20px;
  }

  /* Product Grid */
  .product-grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 Columns */
    gap: 40px;
  }

  .product-card {
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    transition: transform 0.3s ease;
    cursor: pointer;
  }
  
  .product-card:hover {
    transform: translateY(-5px);
  }

  .product-image-wrapper {
    aspect-ratio: 1;
    overflow: hidden;
    margin-bottom: 20px;
    background: #f4f4f4;
    position: relative;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }
  
  .product-card:hover .product-image {
    transform: scale(1.08);
  }

  .product-title {
    font-size: 1.6rem;
    font-weight: 500;
    margin: 0 0 8px 0;
    color: #121212;
  }

  .product-price {
    font-size: 1.5rem;
    color: #444;
    margin: 0;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media screen and (max-width: 750px) {
    .product-grid-container {
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    .filter-bar {
      flex-direction: column;
      align-items: flex-start;
      gap: 20px;
    }
    .filter-left, .filter-right {
      width: 100%;
      justify-content: space-between;
      gap: 10px;
    }
    .product-count {
      margin-left: auto;
    }
  }
</style>

{% schema %}
{
  "name": "Custom Product Grid",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection (Fallback)",
      "info": "This collection will be shown if no blocks are added. Required for Homepage."
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product_item",
          "label": "Choose Product"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Custom Image (Optional)"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Custom Title (Optional)",
          "default": "Product Title"
        },
        {
          "type": "text",
          "id": "price",
          "label": "Custom Price (Optional)",
          "default": "100.00"
        },
         {
          "type": "checkbox",
          "id": "in_stock",
          "label": "In Stock (Override)",
          "default": true
        },
        {
          "type": "url",
          "id": "url",
          "label": "Custom Link (Optional)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Product Grid"
    }
  ]
}
{% endschema %}
